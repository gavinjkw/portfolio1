/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { VerticalAlignment, HorizontalAlignment, Point, getViewportRect } from '../services/overlay/utilities';
import { ConnectedPositioningStrategy } from '../services/overlay/position/connected-positioning-strategy';
import { fadeOut, fadeIn } from '../animations/main';
import { isIE } from '../core/utils';
/** @enum {number} */
const Direction = {
    Top: -1,
    Bottom: 1,
    None: 0,
};
Direction[Direction.Top] = 'Top';
Direction[Direction.Bottom] = 'Bottom';
Direction[Direction.None] = 'None';
/**
 * @hidden \@internal
 */
export class SelectPositioningStrategy extends ConnectedPositioningStrategy {
    /**
     * @param {?} select
     * @param {?=} settings
     */
    constructor(select, settings) {
        super();
        this.select = select;
        this._selectDefaultSettings = {
            target: null,
            horizontalDirection: HorizontalAlignment.Right,
            verticalDirection: VerticalAlignment.Bottom,
            horizontalStartPoint: HorizontalAlignment.Left,
            verticalStartPoint: VerticalAlignment.Top,
            openAnimation: fadeIn,
            closeAnimation: fadeOut
        };
        this.defaultWindowToListOffset = 5;
        this.viewPort = getViewportRect(document);
        this.settings = Object.assign({}, this._selectDefaultSettings, settings);
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} outBoundsAmount
     * @return {?}
     */
    positionAndScrollBottom(contentElement, outBoundsAmount) {
        contentElement.style.top = `${this.viewPort.bottom - this.listContainerBoundRect.height - this.defaultWindowToListOffset}px`;
        contentElement.firstElementChild.scrollTop -= outBoundsAmount - (this.inputBorderTop - this.defaultWindowToListOffset);
        this.deltaY = this.viewPort.bottom - this.listContainerBoundRect.height -
            this.defaultWindowToListOffset - ((/** @type {?} */ (this.select.input.nativeElement.getBoundingClientRect()))).top;
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} CURRENT_POSITION_Y
     * @return {?}
     */
    positionNoScroll(contentElement, CURRENT_POSITION_Y) {
        contentElement.style.top = `${CURRENT_POSITION_Y - this.inputBorderTop}px`;
        this.deltaY = CURRENT_POSITION_Y - this.inputBorderTop -
            ((/** @type {?} */ (this.select.input.nativeElement.getBoundingClientRect()))).top;
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} outBoundsAmount
     * @return {?}
     */
    positionAndScrollTop(contentElement, outBoundsAmount) {
        contentElement.style.top = `${this.viewPort.top + this.defaultWindowToListOffset}px`;
        contentElement.firstElementChild.scrollTop += outBoundsAmount + this.inputBorderTop + this.defaultWindowToListOffset;
        this.deltaY = this.viewPort.top + this.defaultWindowToListOffset -
            ((/** @type {?} */ (this.select.input.nativeElement.getBoundingClientRect()))).top;
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} itemHeight
     * @return {?}
     */
    getItemsOutOfView(contentElement, itemHeight) {
        if (contentElement.firstElementChild.scrollHeight <= contentElement.firstElementChild.clientHeight) {
            return {
                'currentScroll': 0,
                'remainingScroll': 0
            };
        }
        /** @type {?} */
        const currentScroll = contentElement.firstElementChild.scrollTop;
        /** @type {?} */
        const remainingScroll = this.select.items.length * itemHeight - currentScroll - this.listContainerBoundRect.height;
        return {
            'currentScroll': currentScroll,
            'remainingScroll': remainingScroll
        };
    }
    /**
     * @private
     * @param {?} elementContainer
     * @param {?} document
     * @return {?}
     */
    listOutOfBounds(elementContainer, document) {
        /** @type {?} */
        const container = {
            TOP: elementContainer.top,
            BOTTOM: elementContainer.bottom,
        };
        /** @type {?} */
        const viewPort = getViewportRect(document);
        /** @type {?} */
        const documentElement = {
            TOP: viewPort.top,
            BOTTOM: viewPort.bottom
        };
        /** @type {?} */
        const returnVals = {
            Direction: Direction.None,
            Amount: 0
        };
        if (documentElement.TOP + this.defaultWindowToListOffset > container.TOP) {
            returnVals.Direction = Direction.Top;
            returnVals.Amount = documentElement.TOP - container.TOP;
        }
        else if (documentElement.BOTTOM - this.defaultWindowToListOffset < container.BOTTOM) {
            returnVals.Direction = Direction.Bottom;
            returnVals.Amount = container.BOTTOM - documentElement.BOTTOM;
        }
        else {
            return null;
        }
        return returnVals;
    }
    /**
     * @param {?} contentElement
     * @param {?} size
     * @param {?=} document
     * @param {?=} initialCall
     * @return {?}
     */
    position(contentElement, size, document, initialCall) {
        /** @type {?} */
        const inputElement = this.select.input.nativeElement;
        /** @type {?} */
        const inputRect = (/** @type {?} */ (inputElement.getBoundingClientRect()));
        this.listContainerBoundRect = (/** @type {?} */ (contentElement.getBoundingClientRect()));
        /** @type {?} */
        const LIST_HEIGHT = this.listContainerBoundRect.height;
        if (!initialCall) {
            this.deltaX = inputRect.left - this.itemTextPadding - this.itemTextIndent;
            /** @type {?} */
            const point = new Point(this.deltaX, inputRect.top + this.deltaY);
            this.settings.target = point;
            super.position(contentElement, size);
            return;
        }
        /** @type {?} */
        const START = {
            X: inputRect.left,
            Y: inputRect.top
        };
        /** @type {?} */
        let itemElement;
        if (this.select.selectedItem) {
            itemElement = this.select.selectedItem.element.nativeElement;
            // D.P. Feb 22 2019, #3921 Force item scroll before measuring in IE11, due to base scrollToItem delay
            if (isIE()) {
                contentElement.firstElementChild.scrollTop = this.select.calculateScrollPosition(this.select.selectedItem);
            }
        }
        else {
            itemElement = this.select.getFirstItemElement();
        }
        /** @type {?} */
        const inputHeight = inputRect.height;
        /** @type {?} */
        const itemBoundRect = (/** @type {?} */ (itemElement.getBoundingClientRect()));
        /** @type {?} */
        const itemTopListOffset = itemBoundRect.top - this.listContainerBoundRect.top;
        /** @type {?} */
        const itemHeight = itemBoundRect.height;
        /** @type {?} */
        let CURRENT_POSITION_Y = START.Y - itemTopListOffset;
        /** @type {?} */
        const CURRENT_BOTTOM_Y = CURRENT_POSITION_Y + this.listContainerBoundRect.height;
        /** @type {?} */
        const OUT_OF_BOUNDS = this.listOutOfBounds({ top: CURRENT_POSITION_Y, bottom: CURRENT_BOTTOM_Y }, document);
        if (OUT_OF_BOUNDS) {
            if (OUT_OF_BOUNDS.Direction === Direction.Top) {
                CURRENT_POSITION_Y = START.Y;
            }
            else {
                CURRENT_POSITION_Y = -1 * (LIST_HEIGHT - (itemHeight - (itemHeight - inputHeight) / 2));
                CURRENT_POSITION_Y += START.Y;
            }
        }
        /** @type {?} */
        const inputBorderTop = window.getComputedStyle(inputElement).borderTopWidth;
        this.inputBorderTop = parseInt(inputBorderTop.slice(0, inputBorderTop.indexOf('p')), 10) || 0;
        /** @type {?} */
        const itemLeftPadding = window.getComputedStyle(itemElement).paddingLeft;
        /** @type {?} */
        const itemTextIndent = window.getComputedStyle(itemElement).textIndent;
        /** @type {?} */
        const numericPadding = parseInt(itemLeftPadding.slice(0, itemLeftPadding.indexOf('p')), 10) || 0;
        /** @type {?} */
        const numericTextIndent = parseInt(itemTextIndent.slice(0, itemTextIndent.indexOf('r')), 10) || 0;
        this.itemTextPadding = numericPadding;
        this.itemTextIndent = numericTextIndent;
        contentElement.style.left += `${START.X - numericPadding - numericTextIndent}px`;
        contentElement.style.width = inputRect.width + 24 + 32 + 'px';
        this.deltaX = START.X - numericPadding - numericTextIndent;
        /** @type {?} */
        const currentScroll = this.getItemsOutOfView(contentElement, itemHeight)['currentScroll'];
        /** @type {?} */
        const remainingScroll = this.getItemsOutOfView(contentElement, itemHeight)['remainingScroll'];
        // (5 items or less) no scroll and respectively no remaining scroll
        if (remainingScroll === 0 && currentScroll === 0) {
            this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
        }
        // (more than 5 items) there is scroll OR remaining scroll
        if (remainingScroll !== 0 || currentScroll !== 0) {
            if (remainingScroll !== 0 && !OUT_OF_BOUNDS) {
                this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
            }
            // (more than 5 items) and container getting out of the visible port
            if (remainingScroll !== 0 && OUT_OF_BOUNDS) {
                // if there is enough remaining scroll to scroll the item
                if (remainingScroll > itemHeight) {
                    if (OUT_OF_BOUNDS.Direction === Direction.Top) {
                        this.positionAndScrollTop(contentElement, OUT_OF_BOUNDS.Amount);
                        return;
                    }
                    if (OUT_OF_BOUNDS.Direction === Direction.Bottom) {
                        // (more than 5 items) and no current scroll
                        if (currentScroll === 0) {
                            this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
                            return;
                            // (more than 5 items) and current scroll
                        }
                        else {
                            this.positionAndScrollBottom(contentElement, OUT_OF_BOUNDS.Amount);
                            return;
                        }
                    }
                }
                // if there is no enough remaining scroll to scroll the item
                if (remainingScroll < itemHeight) {
                    if (OUT_OF_BOUNDS.Direction === Direction.Top) {
                        this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
                    }
                    if (OUT_OF_BOUNDS.Direction === Direction.Bottom) {
                        this.positionAndScrollBottom(contentElement, OUT_OF_BOUNDS.Amount);
                    }
                }
            }
            // (more than 5 items) and no remaining scroll
            if (remainingScroll === 0 && currentScroll !== 0) {
                if (OUT_OF_BOUNDS) {
                    if (OUT_OF_BOUNDS.Direction === Direction.Bottom) {
                        this.positionAndScrollBottom(contentElement, OUT_OF_BOUNDS.Amount);
                        return;
                    }
                }
                this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
            }
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype._selectDefaultSettings;
    /** @type {?} */
    SelectPositioningStrategy.prototype.settings;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.defaultWindowToListOffset;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.viewPort;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.deltaY;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.deltaX;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.itemTextPadding;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.itemTextIndent;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.inputBorderTop;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.listContainerBoundRect;
    /** @type {?} */
    SelectPositioningStrategy.prototype.select;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9zZWxlY3Qvc2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsbUJBQW1CLEVBQTBCLEtBQUssRUFBRSxlQUFlLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN2SSxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSw2REFBNkQsQ0FBQztBQUUzRyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXJELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7OztJQUlqQyxPQUFRO0lBQ1IsU0FBVTtJQUNWLE9BQVE7Ozs7Ozs7O0FBSVosTUFBTSxPQUFPLHlCQUEwQixTQUFRLDRCQUE0Qjs7Ozs7SUFhdkUsWUFBbUIsTUFBMEIsRUFBRSxRQUEyQjtRQUN0RSxLQUFLLEVBQUUsQ0FBQztRQURPLFdBQU0sR0FBTixNQUFNLENBQW9CO1FBWHJDLDJCQUFzQixHQUFHO1lBQzdCLE1BQU0sRUFBRSxJQUFJO1lBQ1osbUJBQW1CLEVBQUUsbUJBQW1CLENBQUMsS0FBSztZQUM5QyxpQkFBaUIsRUFBRSxpQkFBaUIsQ0FBQyxNQUFNO1lBQzNDLG9CQUFvQixFQUFFLG1CQUFtQixDQUFDLElBQUk7WUFDOUMsa0JBQWtCLEVBQUUsaUJBQWlCLENBQUMsR0FBRztZQUN6QyxhQUFhLEVBQUUsTUFBTTtZQUNyQixjQUFjLEVBQUUsT0FBTztTQUMxQixDQUFDO1FBUU0sOEJBQXlCLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLGFBQVEsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7UUFKekMsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJ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TSxFQUFFO3dCQUM5QyxJQUFJLENBQUMsdUJBQXVCLENBQUMsY0FBYyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQzt3QkFDbkUsT0FBTztxQkFDVjtpQkFDSjtnQkFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7YUFDN0Q7U0FDSjtJQUNMLENBQUM7Q0FDSjs7Ozs7O0lBOU1HLDJEQVFFOztJQUNGLDZDQUFrQzs7Ozs7SUFPbEMsOERBQXNDOzs7OztJQUN0Qyw2Q0FBNkM7Ozs7O0lBQzdDLDJDQUF1Qjs7Ozs7SUFDdkIsMkNBQXVCOzs7OztJQUN2QixvREFBZ0M7Ozs7O0lBQ2hDLG1EQUErQjs7Ozs7SUFDL0IsbURBQStCOzs7OztJQUMvQiwyREFBd0M7O0lBWjVCLDJDQUFpQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFZlcnRpY2FsQWxpZ25tZW50LCBIb3Jpem9udGFsQWxpZ25tZW50LCBQb3NpdGlvblNldHRpbmdzLCBTaXplLCBQb2ludCwgZ2V0Vmlld3BvcnRSZWN0IH0gZnJvbSAnLi4vc2VydmljZXMvb3ZlcmxheS91dGlsaXRpZXMnO1xuaW1wb3J0IHsgQ29ubmVjdGVkUG9zaXRpb25pbmdTdHJhdGVneSB9IGZyb20gJy4uL3NlcnZpY2VzL292ZXJsYXkvcG9zaXRpb24vY29ubmVjdGVkLXBvc2l0aW9uaW5nLXN0cmF0ZWd5JztcbmltcG9ydCB7IElQb3NpdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi4vc2VydmljZXMvb3ZlcmxheS9wb3NpdGlvbic7XG5pbXBvcnQgeyBmYWRlT3V0LCBmYWRlSW4gfSBmcm9tICcuLi9hbmltYXRpb25zL21haW4nO1xuaW1wb3J0IHsgSWd4U2VsZWN0Q29tcG9uZW50IH0gZnJvbSAnLi9zZWxlY3QuY29tcG9uZW50JztcbmltcG9ydCB7IGlzSUUgfSBmcm9tICcuLi9jb3JlL3V0aWxzJztcblxuLyoqIEBoaWRkZW4gKi9cbmVudW0gRGlyZWN0aW9uIHtcbiAgICBUb3AgPSAtMSxcbiAgICBCb3R0b20gPSAxLFxuICAgIE5vbmUgPSAwXG59XG5cbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGNsYXNzIFNlbGVjdFBvc2l0aW9uaW5nU3RyYXRlZ3kgZXh0ZW5kcyBDb25uZWN0ZWRQb3NpdGlvbmluZ1N0cmF0ZWd5IGltcGxlbWVudHMgSVBvc2l0aW9uU3RyYXRlZ3kge1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0RGVmYXVsdFNldHRpbmdzID0ge1xuICAgICAgICB0YXJnZXQ6IG51bGwsXG4gICAgICAgIGhvcml6b250YWxEaXJlY3Rpb246IEhvcml6b250YWxBbGlnbm1lbnQuUmlnaHQsXG4gICAgICAgIHZlcnRpY2FsRGlyZWN0aW9uOiBWZXJ0aWNhbEFsaWdubWVudC5Cb3R0b20sXG4gICAgICAgIGhvcml6b250YWxTdGFydFBvaW50OiBIb3Jpem9udGFsQWxpZ25tZW50LkxlZnQsXG4gICAgICAgIHZlcnRpY2FsU3RhcnRQb2ludDogVmVydGljYWxBbGlnbm1lbnQuVG9wLFxuICAgICAgICBvcGVuQW5pbWF0aW9uOiBmYWRlSW4sXG4gICAgICAgIGNsb3NlQW5pbWF0aW9uOiBmYWRlT3V0XG4gICAgfTtcbiAgICBwdWJsaWMgc2V0dGluZ3M6IFBvc2l0aW9uU2V0dGluZ3M7XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc2VsZWN0OiBJZ3hTZWxlY3RDb21wb25lbnQsIHNldHRpbmdzPzogUG9zaXRpb25TZXR0aW5ncykge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fc2VsZWN0RGVmYXVsdFNldHRpbmdzLCBzZXR0aW5ncyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWZhdWx0V2luZG93VG9MaXN0T2Zmc2V0ID0gNTtcbiAgICBwcml2YXRlIHZpZXdQb3J0ID0gZ2V0Vmlld3BvcnRSZWN0KGRvY3VtZW50KTtcbiAgICBwcml2YXRlIGRlbHRhWTogbnVtYmVyO1xuICAgIHByaXZhdGUgZGVsdGFYOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBpdGVtVGV4dFBhZGRpbmc6IG51bWJlcjtcbiAgICBwcml2YXRlIGl0ZW1UZXh0SW5kZW50OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBpbnB1dEJvcmRlclRvcDogbnVtYmVyO1xuICAgIHByaXZhdGUgbGlzdENvbnRhaW5lckJvdW5kUmVjdDogRE9NUmVjdDtcblxuICAgIHByaXZhdGUgcG9zaXRpb25BbmRTY3JvbGxCb3R0b20oY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LCBvdXRCb3VuZHNBbW91bnQ6IG51bWJlcikge1xuICAgICAgICBjb250ZW50RWxlbWVudC5zdHlsZS50b3AgPSBgJHt0aGlzLnZpZXdQb3J0LmJvdHRvbSAtIHRoaXMubGlzdENvbnRhaW5lckJvdW5kUmVjdC5oZWlnaHQgLSB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXR9cHhgO1xuICAgICAgICBjb250ZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC5zY3JvbGxUb3AgLT0gb3V0Qm91bmRzQW1vdW50IC0gKHRoaXMuaW5wdXRCb3JkZXJUb3AgLSB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXQpO1xuICAgICAgICB0aGlzLmRlbHRhWSA9IHRoaXMudmlld1BvcnQuYm90dG9tIC0gdGhpcy5saXN0Q29udGFpbmVyQm91bmRSZWN0LmhlaWdodCAtXG4gICAgICAgICAgICB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXQgLSAodGhpcy5zZWxlY3QuaW5wdXQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBhcyBET01SZWN0KS50b3A7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwb3NpdGlvbk5vU2Nyb2xsKGNvbnRlbnRFbGVtZW50OiBIVE1MRWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZOiBudW1iZXIpIHtcbiAgICAgICAgY29udGVudEVsZW1lbnQuc3R5bGUudG9wID0gYCR7Q1VSUkVOVF9QT1NJVElPTl9ZIC0gdGhpcy5pbnB1dEJvcmRlclRvcH1weGA7XG4gICAgICAgIHRoaXMuZGVsdGFZID0gQ1VSUkVOVF9QT1NJVElPTl9ZIC0gdGhpcy5pbnB1dEJvcmRlclRvcCAtXG4gICAgICAgICAgICAodGhpcy5zZWxlY3QuaW5wdXQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBhcyBET01SZWN0KS50b3A7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwb3NpdGlvbkFuZFNjcm9sbFRvcChjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIG91dEJvdW5kc0Ftb3VudDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnRlbnRFbGVtZW50LnN0eWxlLnRvcCA9IGAke3RoaXMudmlld1BvcnQudG9wICsgdGhpcy5kZWZhdWx0V2luZG93VG9MaXN0T2Zmc2V0fXB4YDtcbiAgICAgICAgY29udGVudEVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQuc2Nyb2xsVG9wICs9IG91dEJvdW5kc0Ftb3VudCArIHRoaXMuaW5wdXRCb3JkZXJUb3AgKyB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXQ7XG4gICAgICAgIHRoaXMuZGVsdGFZID0gdGhpcy52aWV3UG9ydC50b3AgKyB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXQgLVxuICAgICAgICAgICAgKHRoaXMuc2VsZWN0LmlucHV0Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgYXMgRE9NUmVjdCkudG9wO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0SXRlbXNPdXRPZlZpZXcoY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LCBpdGVtSGVpZ2h0OiBudW1iZXIpOiB7XG4gICAgICAgICdjdXJyZW50U2Nyb2xsJzogbnVtYmVyLFxuICAgICAgICAncmVtYWluaW5nU2Nyb2xsJzogbnVtYmVyXG4gICAgfSB7XG4gICAgICAgIGlmIChjb250ZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC5zY3JvbGxIZWlnaHQgPD0gY29udGVudEVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQuY2xpZW50SGVpZ2h0KSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICdjdXJyZW50U2Nyb2xsJzogMCxcbiAgICAgICAgICAgICAgICAncmVtYWluaW5nU2Nyb2xsJzogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjdXJyZW50U2Nyb2xsID0gY29udGVudEVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQuc2Nyb2xsVG9wO1xuICAgICAgICBjb25zdCByZW1haW5pbmdTY3JvbGwgPSB0aGlzLnNlbGVjdC5pdGVtcy5sZW5ndGggKiBpdGVtSGVpZ2h0IC0gY3VycmVudFNjcm9sbCAtIHRoaXMubGlzdENvbnRhaW5lckJvdW5kUmVjdC5oZWlnaHQ7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnY3VycmVudFNjcm9sbCc6IGN1cnJlbnRTY3JvbGwsXG4gICAgICAgICAgICAncmVtYWluaW5nU2Nyb2xsJzogcmVtYWluaW5nU2Nyb2xsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsaXN0T3V0T2ZCb3VuZHMoZWxlbWVudENvbnRhaW5lcjogeyB0b3A6IG51bWJlciwgYm90dG9tOiBudW1iZXIgfSwgZG9jdW1lbnQ6IERvY3VtZW50KToge1xuICAgICAgICBEaXJlY3Rpb246IERpcmVjdGlvbixcbiAgICAgICAgQW1vdW50OiBudW1iZXJcbiAgICB9IHtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0ge1xuICAgICAgICAgICAgVE9QOiBlbGVtZW50Q29udGFpbmVyLnRvcCxcbiAgICAgICAgICAgIEJPVFRPTTogZWxlbWVudENvbnRhaW5lci5ib3R0b20sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHZpZXdQb3J0ID0gZ2V0Vmlld3BvcnRSZWN0KGRvY3VtZW50KTtcbiAgICAgICAgY29uc3QgZG9jdW1lbnRFbGVtZW50ID0ge1xuICAgICAgICAgICAgVE9QOiB2aWV3UG9ydC50b3AsXG4gICAgICAgICAgICBCT1RUT006IHZpZXdQb3J0LmJvdHRvbVxuICAgICAgICB9O1xuICAgICAgICBjb25zdCByZXR1cm5WYWxzID0ge1xuICAgICAgICAgICAgRGlyZWN0aW9uOiBEaXJlY3Rpb24uTm9uZSxcbiAgICAgICAgICAgIEFtb3VudDogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAoZG9jdW1lbnRFbGVtZW50LlRPUCArIHRoaXMuZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldCA+IGNvbnRhaW5lci5UT1ApIHtcbiAgICAgICAgICAgIHJldHVyblZhbHMuRGlyZWN0aW9uID0gRGlyZWN0aW9uLlRvcDtcbiAgICAgICAgICAgIHJldHVyblZhbHMuQW1vdW50ID0gZG9jdW1lbnRFbGVtZW50LlRPUCAtIGNvbnRhaW5lci5UT1A7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnRFbGVtZW50LkJPVFRPTSAtIHRoaXMuZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldCA8IGNvbnRhaW5lci5CT1RUT00pIHtcbiAgICAgICAgICAgIHJldHVyblZhbHMuRGlyZWN0aW9uID0gRGlyZWN0aW9uLkJvdHRvbTtcbiAgICAgICAgICAgIHJldHVyblZhbHMuQW1vdW50ID0gY29udGFpbmVyLkJPVFRPTSAtIGRvY3VtZW50RWxlbWVudC5CT1RUT007XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0dXJuVmFscztcbiAgICB9XG5cbiAgICBwb3NpdGlvbihjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIHNpemU6IFNpemUsIGRvY3VtZW50PzogRG9jdW1lbnQsIGluaXRpYWxDYWxsPzogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBjb25zdCBpbnB1dEVsZW1lbnQgPSB0aGlzLnNlbGVjdC5pbnB1dC5uYXRpdmVFbGVtZW50O1xuICAgICAgICBjb25zdCBpbnB1dFJlY3QgPSBpbnB1dEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgYXMgRE9NUmVjdDtcbiAgICAgICAgdGhpcy5saXN0Q29udGFpbmVyQm91bmRSZWN0ID0gY29udGVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgYXMgRE9NUmVjdDtcbiAgICAgICAgY29uc3QgTElTVF9IRUlHSFQgPSB0aGlzLmxpc3RDb250YWluZXJCb3VuZFJlY3QuaGVpZ2h0O1xuICAgICAgICBpZiAoIWluaXRpYWxDYWxsKSB7XG4gICAgICAgICAgICB0aGlzLmRlbHRhWCA9IGlucHV0UmVjdC5sZWZ0IC0gdGhpcy5pdGVtVGV4dFBhZGRpbmcgLSB0aGlzLml0ZW1UZXh0SW5kZW50O1xuICAgICAgICAgICAgY29uc3QgcG9pbnQgPSBuZXcgUG9pbnQodGhpcy5kZWx0YVgsIGlucHV0UmVjdC50b3AgKyB0aGlzLmRlbHRhWSk7XG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzLnRhcmdldCA9IHBvaW50O1xuICAgICAgICAgICAgc3VwZXIucG9zaXRpb24oY29udGVudEVsZW1lbnQsIHNpemUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgU1RBUlQgPSB7XG4gICAgICAgICAgICBYOiBpbnB1dFJlY3QubGVmdCxcbiAgICAgICAgICAgIFk6IGlucHV0UmVjdC50b3BcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgaXRlbUVsZW1lbnQ7XG4gICAgICAgIGlmICh0aGlzLnNlbGVjdC5zZWxlY3RlZEl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW1FbGVtZW50ID0gdGhpcy5zZWxlY3Quc2VsZWN0ZWRJdGVtLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICAgICAgICAgIC8vIEQuUC4gRmViIDIyIDIwMTksICMzOTIxIEZvcmNlIGl0ZW0gc2Nyb2xsIGJlZm9yZSBtZWFzdXJpbmcgaW4gSUUxMSwgZHVlIHRvIGJhc2Ugc2Nyb2xsVG9JdGVtIGRlbGF5XG4gICAgICAgICAgICBpZiAoaXNJRSgpKSB7XG4gICAgICAgICAgICAgICAgY29udGVudEVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQuc2Nyb2xsVG9wID0gdGhpcy5zZWxlY3QuY2FsY3VsYXRlU2Nyb2xsUG9zaXRpb24odGhpcy5zZWxlY3Quc2VsZWN0ZWRJdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGl0ZW1FbGVtZW50ID0gdGhpcy5zZWxlY3QuZ2V0Rmlyc3RJdGVtRWxlbWVudCgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGlucHV0SGVpZ2h0ID0gaW5wdXRSZWN0LmhlaWdodDtcbiAgICAgICAgY29uc3QgaXRlbUJvdW5kUmVjdCA9IGl0ZW1FbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpIGFzIERPTVJlY3Q7XG4gICAgICAgIGNvbnN0IGl0ZW1Ub3BMaXN0T2Zmc2V0ID0gaXRlbUJvdW5kUmVjdC50b3AgLSB0aGlzLmxpc3RDb250YWluZXJCb3VuZFJlY3QudG9wO1xuICAgICAgICBjb25zdCBpdGVtSGVpZ2h0ID0gaXRlbUJvdW5kUmVjdC5oZWlnaHQ7XG5cbiAgICAgICAgbGV0IENVUlJFTlRfUE9TSVRJT05fWSA9IFNUQVJULlkgLSBpdGVtVG9wTGlzdE9mZnNldDtcbiAgICAgICAgY29uc3QgQ1VSUkVOVF9CT1RUT01fWSA9IENVUlJFTlRfUE9TSVRJT05fWSArIHRoaXMubGlzdENvbnRhaW5lckJvdW5kUmVjdC5oZWlnaHQ7XG5cbiAgICAgICAgY29uc3QgT1VUX09GX0JPVU5EUzoge1xuICAgICAgICAgICAgRGlyZWN0aW9uOiBEaXJlY3Rpb24sXG4gICAgICAgICAgICBBbW91bnQ6IG51bWJlclxuICAgICAgICB9ID0gdGhpcy5saXN0T3V0T2ZCb3VuZHMoeyB0b3A6IENVUlJFTlRfUE9TSVRJT05fWSwgYm90dG9tOiBDVVJSRU5UX0JPVFRPTV9ZIH0sIGRvY3VtZW50KTtcbiAgICAgICAgaWYgKE9VVF9PRl9CT1VORFMpIHtcbiAgICAgICAgICAgIGlmIChPVVRfT0ZfQk9VTkRTLkRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLlRvcCkge1xuICAgICAgICAgICAgICAgIENVUlJFTlRfUE9TSVRJT05fWSA9IFNUQVJULlk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIENVUlJFTlRfUE9TSVRJT05fWSA9IC0xICogKExJU1RfSEVJR0hUIC0gKGl0ZW1IZWlnaHQgLSAoaXRlbUhlaWdodCAtIGlucHV0SGVpZ2h0KSAvIDIpKTtcbiAgICAgICAgICAgICAgICBDVVJSRU5UX1BPU0lUSU9OX1kgKz0gU1RBUlQuWTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbnB1dEJvcmRlclRvcCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGlucHV0RWxlbWVudCkuYm9yZGVyVG9wV2lkdGg7XG4gICAgICAgIHRoaXMuaW5wdXRCb3JkZXJUb3AgPSBwYXJzZUludChpbnB1dEJvcmRlclRvcC5zbGljZSgwLCBpbnB1dEJvcmRlclRvcC5pbmRleE9mKCdwJykpLCAxMCkgfHwgMDtcbiAgICAgICAgY29uc3QgaXRlbUxlZnRQYWRkaW5nID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaXRlbUVsZW1lbnQpLnBhZGRpbmdMZWZ0O1xuICAgICAgICBjb25zdCBpdGVtVGV4dEluZGVudCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGl0ZW1FbGVtZW50KS50ZXh0SW5kZW50O1xuICAgICAgICBjb25zdCBudW1lcmljUGFkZGluZyA9IHBhcnNlSW50KGl0ZW1MZWZ0UGFkZGluZy5zbGljZSgwLCBpdGVtTGVmdFBhZGRpbmcuaW5kZXhPZigncCcpKSwgMTApIHx8IDA7XG4gICAgICAgIGNvbnN0IG51bWVyaWNUZXh0SW5kZW50ID0gcGFyc2VJbnQoaXRlbVRleHRJbmRlbnQuc2xpY2UoMCwgaXRlbVRleHRJbmRlbnQuaW5kZXhPZigncicpKSwgMTApIHx8IDA7XG4gICAgICAgIHRoaXMuaXRlbVRleHRQYWRkaW5nID0gbnVtZXJpY1BhZGRpbmc7XG4gICAgICAgIHRoaXMuaXRlbVRleHRJbmRlbnQgPSBudW1lcmljVGV4dEluZGVudDtcbiAgICAgICAgY29udGVudEVsZW1lbnQuc3R5bGUubGVmdCArPSBgJHtTVEFSVC5YIC0gbnVtZXJpY1BhZGRpbmcgLSBudW1lcmljVGV4dEluZGVudH1weGA7XG4gICAgICAgIGNvbnRlbnRFbGVtZW50LnN0eWxlLndpZHRoID0gaW5wdXRSZWN0LndpZHRoICsgMjQgKyAzMiArICdweCc7XG4gICAgICAgIHRoaXMuZGVsdGFYID0gU1RBUlQuWCAtIG51bWVyaWNQYWRkaW5nIC0gbnVtZXJpY1RleHRJbmRlbnQ7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTY3JvbGwgPSB0aGlzLmdldEl0ZW1zT3V0T2ZWaWV3KGNvbnRlbnRFbGVtZW50LCBpdGVtSGVpZ2h0KVsnY3VycmVudFNjcm9sbCddO1xuICAgICAgICBjb25zdCByZW1haW5pbmdTY3JvbGwgPSB0aGlzLmdldEl0ZW1zT3V0T2ZWaWV3KGNvbnRlbnRFbGVtZW50LCBpdGVtSGVpZ2h0KVsncmVtYWluaW5nU2Nyb2xsJ107XG5cbiAgICAgICAgLy8gKDUgaXRlbXMgb3IgbGVzcykgbm8gc2Nyb2xsIGFuZCByZXNwZWN0aXZlbHkgbm8gcmVtYWluaW5nIHNjcm9sbFxuICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsID09PSAwICYmIGN1cnJlbnRTY3JvbGwgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcbiAgICAgICAgfVxuICAgICAgICAvLyAobW9yZSB0aGFuIDUgaXRlbXMpIHRoZXJlIGlzIHNjcm9sbCBPUiByZW1haW5pbmcgc2Nyb2xsXG4gICAgICAgIGlmIChyZW1haW5pbmdTY3JvbGwgIT09IDAgfHwgY3VycmVudFNjcm9sbCAhPT0gMCkge1xuICAgICAgICAgICAgaWYgKHJlbWFpbmluZ1Njcm9sbCAhPT0gMCAmJiAhT1VUX09GX0JPVU5EUykge1xuICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIChtb3JlIHRoYW4gNSBpdGVtcykgYW5kIGNvbnRhaW5lciBnZXR0aW5nIG91dCBvZiB0aGUgdmlzaWJsZSBwb3J0XG4gICAgICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsICE9PSAwICYmIE9VVF9PRl9CT1VORFMpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBlbm91Z2ggcmVtYWluaW5nIHNjcm9sbCB0byBzY3JvbGwgdGhlIGl0ZW1cbiAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsID4gaXRlbUhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUy5EaXJlY3Rpb24gPT09IERpcmVjdGlvbi5Ub3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25BbmRTY3JvbGxUb3AoY29udGVudEVsZW1lbnQsIE9VVF9PRl9CT1VORFMuQW1vdW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUy5EaXJlY3Rpb24gPT09IERpcmVjdGlvbi5Cb3R0b20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIChtb3JlIHRoYW4gNSBpdGVtcykgYW5kIG5vIGN1cnJlbnQgc2Nyb2xsXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjcm9sbCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAobW9yZSB0aGFuIDUgaXRlbXMpIGFuZCBjdXJyZW50IHNjcm9sbFxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uQW5kU2Nyb2xsQm90dG9tKGNvbnRlbnRFbGVtZW50LCBPVVRfT0ZfQk9VTkRTLkFtb3VudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGVub3VnaCByZW1haW5pbmcgc2Nyb2xsIHRvIHNjcm9sbCB0aGUgaXRlbVxuICAgICAgICAgICAgICAgIGlmIChyZW1haW5pbmdTY3JvbGwgPCBpdGVtSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChPVVRfT0ZfQk9VTkRTLkRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLlRvcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbk5vU2Nyb2xsKGNvbnRlbnRFbGVtZW50LCBDVVJSRU5UX1BPU0lUSU9OX1kpO1xuXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKE9VVF9PRl9CT1VORFMuRGlyZWN0aW9uID09PSBEaXJlY3Rpb24uQm90dG9tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uQW5kU2Nyb2xsQm90dG9tKGNvbnRlbnRFbGVtZW50LCBPVVRfT0ZfQk9VTkRTLkFtb3VudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyAobW9yZSB0aGFuIDUgaXRlbXMpIGFuZCBubyByZW1haW5pbmcgc2Nyb2xsXG4gICAgICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsID09PSAwICYmIGN1cnJlbnRTY3JvbGwgIT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUy5EaXJlY3Rpb24gPT09IERpcmVjdGlvbi5Cb3R0b20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25BbmRTY3JvbGxCb3R0b20oY29udGVudEVsZW1lbnQsIE9VVF9PRl9CT1VORFMuQW1vdW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uTm9TY3JvbGwoY29udGVudEVsZW1lbnQsIENVUlJFTlRfUE9TSVRJT05fWSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=